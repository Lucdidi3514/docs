---
title: 'Migrations Database'
description: 'Gestion des 43 migrations Supabase avec processus de d√©ploiement et rollback'
---

## Vue d'ensemble

Kit'Asso utilise **43 fichiers de migration SQL** qui tracent l'√©volution compl√®te du sch√©ma de base de donn√©es. Chaque migration est versionn√©e avec un timestamp et document√©e pour faciliter le d√©ploiement et le rollback.

**Convention de nommage :**
```
YYYYMMDDHHMMSS_description.sql
```

**Exemple :**
```
20240115103000_create_tools_table.sql
20240115104500_add_rls_policies_tools.sql
20240116091200_create_workflows_table.sql
```

**Avantages :**
- Historique complet des changements de sch√©ma
- D√©ploiement reproductible sur tous les environnements
- Rollback possible en cas d'erreur
- Documentation int√©gr√©e dans les fichiers SQL

---

## Structure d'une migration

### Migration compl√®te typique

**Fichier :** `20240115103000_create_tools_table.sql`

```sql
-- Description: Cr√©ation de la table tools pour le catalogue d'outils
-- Created: 2024-01-15
-- Author: Kit'Asso Team

-- ============================================
-- 1. CREATE TABLE
-- ============================================

CREATE TABLE IF NOT EXISTS tools (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name TEXT UNIQUE NOT NULL,
  description TEXT NOT NULL,
  pricing_tier TEXT CHECK (pricing_tier IN ('Gratuit', 'Freemium', 'Payant', 'Entreprise')),
  category_id UUID REFERENCES categories(id) ON DELETE SET NULL,
  logo_url TEXT,
  website_url TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ============================================
-- 2. CREATE INDEXES
-- ============================================

CREATE INDEX IF NOT EXISTS idx_tools_category_id ON tools(category_id);
CREATE INDEX IF NOT EXISTS idx_tools_pricing_tier ON tools(pricing_tier);
CREATE INDEX IF NOT EXISTS idx_tools_name ON tools(name);

-- ============================================
-- 3. ENABLE ROW LEVEL SECURITY
-- ============================================

ALTER TABLE tools ENABLE ROW LEVEL SECURITY;

-- ============================================
-- 4. CREATE RLS POLICIES
-- ============================================

-- Public read
CREATE POLICY "Allow public read on tools"
  ON tools
  FOR SELECT
  TO public
  USING (true);

-- Authenticated insert
CREATE POLICY "Allow authenticated insert on tools"
  ON tools
  FOR INSERT
  TO authenticated
  WITH CHECK (true);

-- Authenticated update
CREATE POLICY "Allow authenticated update on tools"
  ON tools
  FOR UPDATE
  TO authenticated
  USING (true)
  WITH CHECK (true);

-- Authenticated delete
CREATE POLICY "Allow authenticated delete on tools"
  ON tools
  FOR DELETE
  TO authenticated
  USING (true);

-- ============================================
-- 5. COMMENTS (Documentation)
-- ============================================

COMMENT ON TABLE tools IS 'Catalogue des outils num√©riques pour associations';
COMMENT ON COLUMN tools.name IS 'Nom unique de l''outil';
COMMENT ON COLUMN tools.pricing_tier IS 'Mod√®le tarifaire (Gratuit, Freemium, Payant, Entreprise)';
```

---

## Chronologie des migrations

### Phase 1 : Tables Core (Migrations 1-15)

**Migrations principales :**

```
20240115103000_create_categories_table.sql
20240115103500_create_tools_table.sql
20240115104000_create_filters_table.sql
20240115104500_create_tool_features_table.sql
20240115105000_add_rls_policies_core_tables.sql
20240116091000_create_site_assets_table.sql
```

**Contenu :**
- Cr√©ation des tables fondamentales (tools, categories, filters)
- Relations many-to-many avec tool_features
- Indexes pour performance
- RLS policies pour s√©curit√©
- Table site_assets pour gestion centralis√©e

---

### Phase 2 : Workflows (Migrations 16-25)

**Migrations principales :**

```
20240116092000_create_workflows_table.sql
20240116093000_create_workflow_steps_table.sql
20240116094000_add_workflow_jsonb_fields.sql
20240116095000_add_workflow_steps_rich_content.sql
20240117081000_add_rls_policies_workflows.sql
```

**Contenu :**
- Table workflows avec champs JSONB (steps, next_steps, resources)
- Table workflow_steps avec contenu enrichi (story, visuals, videos)
- Contraintes CHECK pour difficulty et status
- Policies RLS distinctes pour workflows actifs vs drafts
- Indexes sur status et display_order

**Evolution :**
```sql
-- Initial : steps en JSONB simple
ALTER TABLE workflows ADD COLUMN steps JSONB DEFAULT '[]';

-- Enrichissement : ajout de detailed_instructions, practical_tip
ALTER TABLE workflow_steps ADD COLUMN detailed_instructions JSONB DEFAULT '[]';
ALTER TABLE workflow_steps ADD COLUMN practical_tip TEXT;

-- Contenu avanc√© : story, visuals, videos
ALTER TABLE workflow_steps ADD COLUMN story JSONB;
ALTER TABLE workflow_steps ADD COLUMN visuals JSONB;
ALTER TABLE workflow_steps ADD COLUMN videos JSONB;
```

---

### Phase 3 : Tool Packs (Migrations 26-32)

**Migrations principales :**

```
20240117090000_create_tool_packs_table.sql
20240117091000_create_pack_tools_table.sql
20240117092000_add_pack_display_order.sql
20240117093000_add_rls_policies_packs.sql
```

**Contenu :**
- Table tool_packs avec icon, color, difficulty
- Table pack_tools (join table avec display_order)
- Contraintes UNIQUE sur (pack_id, tool_id)
- Status active/draft pour packs
- Policies pour filtrer packs actifs c√¥t√© public

---

### Phase 4 : Quiz System (Migrations 33-43)

**Migrations principales :**

```
20240118100000_create_quizzes_table.sql
20240118101000_create_quiz_questions_table.sql
20240118102000_create_quiz_answers_table.sql
20240118103000_create_quiz_recommendations_table.sql
20240118104000_create_quiz_responses_table.sql
20240118105000_add_rls_policies_quiz.sql
20240118110000_add_quiz_condition_logic.sql
```

**Contenu :**
- Tables pour quiz complet (quizzes, questions, answers, recommendations, responses)
- Champ JSONB condition_logic pour recommandations
- Policies complexes (public insert sur responses, read via parent quiz)
- Slug unique pour routing
- Arrays UUID pour recommended_pack_ids et recommended_tool_ids

**Evolution :**
```sql
-- Initial : quiz basique
CREATE TABLE quizzes (
  id UUID PRIMARY KEY,
  title TEXT NOT NULL,
  slug TEXT UNIQUE NOT NULL
);

-- Ajout logique conditionnelle
ALTER TABLE quiz_recommendations 
  ADD COLUMN condition_logic JSONB NOT NULL;

-- Ajout capture email
ALTER TABLE quiz_responses 
  ADD COLUMN email TEXT;
```

---

## Processus de d√©ploiement

### Environnement local

**Pr√©requis :**
- Projet Supabase cr√©√©
- Acc√®s au SQL Editor dans le dashboard

**M√©thode 1 : Dashboard Supabase**

1. Ouvrir Supabase Dashboard ‚Üí SQL Editor
2. Copier le contenu de la migration
3. Ex√©cuter le SQL
4. V√©rifier le r√©sultat dans Table Editor

**M√©thode 2 : Supabase CLI (recommand√©)**

```bash
# Installation CLI
npm install -g supabase

# Login
supabase login

# Link au projet
supabase link --project-ref your-project-ref

# Appliquer les migrations
supabase db push

# V√©rifier le status
supabase db status
```

---

### Environnement de production

**Processus complet :**

```bash
# 1. Backup de la base actuelle
supabase db dump -f backup_$(date +%Y%m%d_%H%M%S).sql

# 2. Tester les migrations en local d'abord
supabase db reset # Reset local DB
supabase db push  # Applique toutes les migrations

# 3. Si tests OK, d√©ployer en production
supabase db push --linked

# 4. V√©rifier les tables cr√©√©es
supabase db status
```

**Checklist de d√©ploiement :**
- ‚úÖ Backup effectu√©
- ‚úÖ Migrations test√©es en local
- ‚úÖ RLS policies v√©rifi√©es
- ‚úÖ Indexes cr√©√©s
- ‚úÖ Contraintes valid√©es
- ‚úÖ Donn√©es de test ins√©r√©es
- ‚úÖ Frontend fonctionne avec nouveau sch√©ma

---

## Ordre d'ex√©cution des migrations

**CRITIQUE : Respecter l'ordre chronologique**

```bash
# ‚ùå MAUVAIS : ex√©cuter dans le d√©sordre
20240118_create_quiz_questions.sql  # √âchoue : quiz table n'existe pas
20240118_create_quizzes.sql

# ‚úÖ BON : ordre chronologique
20240118100000_create_quizzes_table.sql
20240118101000_create_quiz_questions_table.sql  # OK : quiz existe
```

**D√©pendances entre migrations :**

```
categories ‚Üí tools (foreign key category_id)
tools + filters ‚Üí tool_features (join table)
workflows ‚Üí workflow_steps (foreign key workflow_id)
tool_packs ‚Üí pack_tools (foreign key pack_id)
quizzes ‚Üí quiz_questions ‚Üí quiz_answers (cascade)
```

**Script d'ex√©cution compl√®te :**

```bash
#!/bin/bash
# apply_all_migrations.sh

MIGRATIONS_DIR="supabase/migrations"

for file in $(ls -1 $MIGRATIONS_DIR/*.sql | sort); do
  echo "Applying: $file"
  psql $DATABASE_URL -f $file
  
  if [ $? -eq 0 ]; then
    echo "‚úÖ Success: $file"
  else
    echo "‚ùå Failed: $file"
    exit 1
  fi
done

echo "üéâ All migrations applied successfully"
```

---

## Rollback de migrations

### Rollback simple (derni√®re migration)

**Cr√©er un fichier de rollback :**

**Fichier :** `20240118110000_add_quiz_condition_logic_rollback.sql`

```sql
-- Rollback for: 20240118110000_add_quiz_condition_logic.sql

-- Remove column
ALTER TABLE quiz_recommendations DROP COLUMN IF EXISTS condition_logic;

-- Remove policies (if created)
DROP POLICY IF EXISTS "policy_name" ON table_name;

-- Drop indexes (if created)
DROP INDEX IF EXISTS idx_name;
```

**Ex√©cution :**
```bash
psql $DATABASE_URL -f rollback_file.sql
```

---

### Rollback complet (retour √† version ant√©rieure)

**Option 1 : Restauration depuis backup**

```bash
# Restaurer backup
psql $DATABASE_URL < backup_20240115.sql

# R√©-appliquer migrations jusqu'au point souhait√©
for file in $(ls migrations/ | head -n 25); do
  psql $DATABASE_URL -f migrations/$file
done
```

**Option 2 : Supabase CLI**

```bash
# Reset complet (‚ö†Ô∏è DANGER : perte de donn√©es)
supabase db reset

# R√©-appliquer migrations s√©lectives
supabase db push
```

---

### Migrations r√©versibles

**Pattern de migration avec UP et DOWN :**

```sql
-- ============================================
-- UP Migration
-- ============================================

CREATE TABLE new_table (...);

-- ============================================
-- DOWN Migration (Commented, for reference)
-- ============================================

-- DROP TABLE IF EXISTS new_table;
```

**Usage :** Garder le code de rollback en commentaire pour r√©f√©rence.

---

## Bonnes pratiques

### ‚úÖ √Ä faire

**Toujours tester en local avant production**
```bash
# 1. Reset local
supabase db reset

# 2. Appliquer nouvelle migration
psql local_db -f new_migration.sql

# 3. V√©rifier avec des queries
SELECT * FROM new_table;

# 4. Tester depuis frontend
npm run dev
```

**Utiliser des transactions pour migrations complexes**
```sql
BEGIN;

-- Plusieurs op√©rations
ALTER TABLE tools ADD COLUMN new_field TEXT;
UPDATE tools SET new_field = 'default_value';
ALTER TABLE tools ALTER COLUMN new_field SET NOT NULL;

COMMIT;
-- Si erreur, rien n'est appliqu√©
```

**Documenter chaque migration**
```sql
-- Migration: Add email capture to quiz responses
-- Date: 2024-01-18
-- Reason: Allow follow-up communication with quiz takers
-- Impact: No breaking changes, nullable column

ALTER TABLE quiz_responses ADD COLUMN email TEXT;
```

**Cr√©er des indexes pour colonnes fr√©quemment requ√™t√©es**
```sql
-- Souvent utilis√© dans WHERE clauses
CREATE INDEX idx_workflows_status ON workflows(status);

-- Souvent utilis√© dans JOIN
CREATE INDEX idx_tool_features_tool_id ON tool_features(tool_id);

-- Souvent utilis√© dans ORDER BY
CREATE INDEX idx_workflows_display_order ON workflows(display_order);
```

---

### ‚ùå √Ä √©viter

**Ne jamais modifier une migration d√©j√† d√©ploy√©e**
```bash
# ‚ùå MAUVAIS : √©diter 20240115_create_tools.sql apr√®s d√©ploiement

# ‚úÖ BON : cr√©er une nouvelle migration
20240120_alter_tools_add_column.sql
```

**Ne pas supprimer des colonnes sans migration de donn√©es**
```sql
-- ‚ùå DANGER : perte de donn√©es
ALTER TABLE tools DROP COLUMN logo_url;

-- ‚úÖ BON : migrer d'abord vers storage, puis supprimer
-- Migration 1: Copier logo_url vers storage
-- Migration 2: V√©rifier que toutes les donn√©es sont migr√©es
-- Migration 3: Supprimer la colonne
```

**Ne pas oublier les contraintes CASCADE**
```sql
-- ‚ùå Mauvais : ON DELETE RESTRICT (bloque la suppression)
ALTER TABLE workflow_steps
  ADD CONSTRAINT fk_workflow
  FOREIGN KEY (workflow_id) REFERENCES workflows(id);

-- ‚úÖ Bon : ON DELETE CASCADE (supprime les steps automatiquement)
ALTER TABLE workflow_steps
  ADD CONSTRAINT fk_workflow
  FOREIGN KEY (workflow_id) REFERENCES workflows(id)
  ON DELETE CASCADE;
```

---

## V√©rification post-migration

### Checklist de validation

```sql
-- 1. V√©rifier que toutes les tables existent
SELECT tablename FROM pg_tables 
WHERE schemaname = 'public' 
ORDER BY tablename;

-- 2. V√©rifier RLS activ√©
SELECT tablename, rowsecurity 
FROM pg_tables 
WHERE schemaname = 'public';

-- 3. Lister toutes les policies
SELECT tablename, policyname 
FROM pg_policies 
WHERE schemaname = 'public'
ORDER BY tablename;

-- 4. V√©rifier les indexes
SELECT tablename, indexname 
FROM pg_indexes 
WHERE schemaname = 'public'
ORDER BY tablename;

-- 5. Compter les enregistrements
SELECT 
  'tools' as table_name, COUNT(*) FROM tools
UNION ALL
SELECT 'workflows', COUNT(*) FROM workflows
UNION ALL
SELECT 'tool_packs', COUNT(*) FROM tool_packs;
```

---

## Ressources

<CardGroup cols={2}>
  <Card title="Database Schema" icon="database" href="/database/schema">
    Structure compl√®te des 13 tables cr√©√©es
  </Card>
  <Card title="RLS Policies" icon="shield" href="/database/rls">
    S√©curit√© appliqu√©e dans les migrations
  </Card>
  <Card title="Supabase Setup" icon="cloud" href="/deployment/supabase">
    Configuration du projet Supabase
  </Card>
  <Card title="Storage Buckets" icon="folder" href="/database/storage">
    Migrations des buckets Supabase Storage
  </Card>
</CardGroup>