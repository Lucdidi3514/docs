---
title: 'Configuration Supabase'
description: 'Setup complet du backend Supabase en production'
---

## Cr√©ation du projet

### Nouveau projet Supabase

<Steps>
  <Step title="Cr√©er le projet">
    1. Allez sur [supabase.com](https://supabase.com)
    2. Cliquez sur **"New Project"**
    3. Remplissez :
       - **Name:** Kit'Asso Production
       - **Database Password:** G√©n√©rer un mot de passe fort
       - **Region:** Europe (Frankfurt ou Paris)
       - **Pricing Plan:** Free (ou Pro si besoin)
  </Step>
  
  <Step title="Attendre le provisioning">
    ‚è±Ô∏è **Dur√©e :** 2-5 minutes
    
    Supabase cr√©e :
    - Base de donn√©es PostgreSQL
    - API REST auto-g√©n√©r√©e
    - Realtime subscriptions
    - Storage buckets
    - Auth service
  </Step>
  
  <Step title="R√©cup√©rer les credentials">
    Dans **Project Settings** ‚Üí **API** :
    
    - **Project URL:** `https://xxxxx.supabase.co`
    - **anon public key:** `eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...`
    - **service_role key:** ‚ö†Ô∏è √Ä ne JAMAIS exposer c√¥t√© client
    
    Copiez ces valeurs pour Netlify
  </Step>
</Steps>

---

## Migrations de base de donn√©es

### Option 1 : SQL Editor (recommand√© pour d√©marrer)

<Steps>
  <Step title="Ouvrir SQL Editor">
    Dans le dashboard Supabase ‚Üí **SQL Editor**
  </Step>
  
  <Step title="Ex√©cuter les migrations">
    Les migrations sont dans `supabase/migrations/` (43 fichiers).
    
    **Ordre chronologique strict :**
    ```
    20240101000000_initial_schema.sql
    20240102000000_add_categories.sql
    20240103000000_add_workflows.sql
    ...
    ```
    
    Pour chaque fichier :
    1. Ouvrir le fichier local
    2. Copier le contenu
    3. Coller dans SQL Editor
    4. Cliquer sur **"Run"**
    5. V√©rifier le succ√®s (pas d'erreur rouge)
  </Step>
  
  <Step title="V√©rifier les tables">
    Dans **Table Editor**, vous devez voir 13 tables :
    
    - tools
    - categories
    - filters
    - tool_features
    - workflows
    - workflow_steps
    - tool_packs
    - pack_tools
    - quizzes
    - quiz_questions
    - quiz_answers
    - quiz_recommendations
    - quiz_responses
    - site_assets
  </Step>
</Steps>

<Tip>
  Pour acc√©l√©rer, combinez plusieurs migrations en un seul script si elles ne cr√©ent pas de d√©pendances cycliques
</Tip>

---

### Option 2 : Supabase CLI

Si vous avez install√© le CLI :

```bash
# Installer Supabase CLI
npm install -g supabase

# Login
supabase login

# Lier au projet
supabase link --project-ref xxxxx

# Push toutes les migrations
supabase db push
```

**Avantages :**
- Toutes les migrations en une commande
- Historique des migrations track√©es
- Rollback possible

---

## Row Level Security (RLS)

### V√©rifier que RLS est activ√©

```sql
-- Pour chaque table, v√©rifier :
SELECT tablename, rowsecurity 
FROM pg_tables 
WHERE schemaname = 'public';
```

Toutes les tables doivent avoir `rowsecurity = true`.

---

### Policies par table

Les policies sont d√©finies dans les migrations. V√©rifiez :

**Exemple : table `tools`**

```sql
-- Public : lecture seule
CREATE POLICY "Allow public read on tools"
  ON tools FOR SELECT
  TO public
  USING (true);

-- Authenticated : CRUD complet
CREATE POLICY "Allow authenticated insert on tools"
  ON tools FOR INSERT
  TO authenticated
  WITH CHECK (true);

CREATE POLICY "Allow authenticated update on tools"
  ON tools FOR UPDATE
  TO authenticated
  USING (true) WITH CHECK (true);

CREATE POLICY "Allow authenticated delete on tools"
  ON tools FOR DELETE
  TO authenticated
  USING (true);
```

**Tester les policies :**

```sql
-- En tant que public (sans auth)
SELECT * FROM tools; -- ‚úÖ Devrait fonctionner

INSERT INTO tools (name, description) 
VALUES ('Test', 'Test'); -- ‚ùå Devrait √©chouer

-- En tant qu'authenticated
-- (cr√©ez un user via Auth pour tester)
```

---

## Storage Buckets

### Cr√©er les buckets

<Steps>
  <Step title="Aller dans Storage">
    Dashboard Supabase ‚Üí **Storage**
  </Step>
  
  <Step title="Cr√©er bucket tool_logos">
    - **Name:** `tool_logos`
    - **Public bucket:** ‚úÖ Yes
    - **File size limit:** 2 MB
    - **Allowed MIME types:** `image/*`
  </Step>
  
  <Step title="Cr√©er bucket site_assets">
    - **Name:** `site_assets`
    - **Public bucket:** ‚úÖ Yes
    - **File size limit:** 5 MB
    - **Allowed MIME types:** `image/*, video/*`
  </Step>
</Steps>

---

### Policies Storage

```sql
-- Bucket tool_logos : Public read, Authenticated write
CREATE POLICY "Public read tool_logos"
  ON storage.objects FOR SELECT
  USING (bucket_id = 'tool_logos');

CREATE POLICY "Authenticated upload tool_logos"
  ON storage.objects FOR INSERT
  TO authenticated
  WITH CHECK (bucket_id = 'tool_logos');

CREATE POLICY "Authenticated delete tool_logos"
  ON storage.objects FOR DELETE
  TO authenticated
  USING (bucket_id = 'tool_logos');
```

**Tester l'upload :**

```typescript
// Dans votre app (authenticated)
import { toolsApi } from '@/api';

const file = // ... r√©cup√©r√© depuis input file
const publicUrl = await toolsApi.uploadLogo(file);
console.log(publicUrl); // https://xxxxx.supabase.co/storage/v1/object/public/tool_logos/...
```

---

## Authentication

### Configurer Auth

<Steps>
  <Step title="Aller dans Authentication">
    Dashboard ‚Üí **Authentication** ‚Üí **Settings**
  </Step>
  
  <Step title="D√©sactiver les inscriptions publiques">
    **Enable email signups:** ‚ùå Off
    
    Seuls les admins cr√©eront des comptes depuis le dashboard
  </Step>
  
  <Step title="Configurer Email Templates (optionnel)">
    **Email Templates** ‚Üí Personnalisez :
    - Confirmation Email
    - Magic Link
    - Reset Password
  </Step>
</Steps>

---

### Cr√©er un utilisateur admin

<Steps>
  <Step title="Aller dans Users">
    **Authentication** ‚Üí **Users** ‚Üí **Add user**
  </Step>
  
  <Step title="Cr√©er le user">
    - **Email:** `admin@kitasso.com`
    - **Password:** G√©n√©rer un mot de passe fort
    - **Auto Confirm User:** ‚úÖ Yes
  </Step>
  
  <Step title="Tester la connexion">
    Sur votre app d√©ploy√©e :
    1. Allez sur `/admin`
    2. Redirig√© vers `/login`
    3. Connectez-vous avec les credentials
    4. Devrait acc√©der au dashboard admin
  </Step>
</Steps>

---

## Performance & Indexes

### V√©rifier les indexes

```sql
-- Lister tous les indexes
SELECT 
  tablename, 
  indexname, 
  indexdef 
FROM pg_indexes 
WHERE schemaname = 'public';
```

Les migrations devraient avoir cr√©√© des indexes sur :
- `tools.category_id`
- `tools.pricing_tier`
- `tool_features.tool_id`
- `tool_features.filter_id`
- `workflow_steps.workflow_id`
- `pack_tools.pack_id`
- etc.

---

### Connection Pooling

Supabase g√®re automatiquement le pooling avec PgBouncer.

**Limites par plan :**
- **Free:** 60 connections
- **Pro:** 200 connections
- **Enterprise:** Custom

Si vous d√©passez, utilisez Supabase Connection Pooler :

```typescript
// Au lieu de :
const supabase = createClient(url, anonKey);

// Utilisez :
const supabase = createClient(poolerUrl, anonKey);
```

---

## Monitoring

### Database Health

**Dashboard** ‚Üí **Database** ‚Üí **Health**

Surveillez :
- **CPU Usage:** < 80%
- **Memory Usage:** < 80%
- **Disk Usage:** < 80%
- **Connections:** < max limit

---

### Logs

**Dashboard** ‚Üí **Logs**

Filtres :
- **API:** Requ√™tes REST
- **Database:** Queries SQL
- **Auth:** Login attempts
- **Storage:** Uploads/downloads

**Recherche par erreur :**
```
status:400
status:500
error
```

---

### API Analytics

**Dashboard** ‚Üí **API**

Graphiques :
- Requests per second
- Response times (p50, p95, p99)
- Error rates
- Cache hit ratio

---

## Backups

### Automatic Backups

Supabase cr√©e automatiquement des backups :

**Free plan :**
- 1 backup par jour
- R√©tention : 7 jours

**Pro plan :**
- Backups PITR (Point In Time Recovery)
- R√©tention : 7-30 jours
- Restore √† n'importe quel point

---

### Manual Backup

```bash
# Via CLI
supabase db dump -f backup.sql

# Ou via pgAdmin connect√© √† Supabase
```

---

## S√©curit√©

### API Keys

<Warning>
  Ne commitez JAMAIS les cl√©s dans Git !
</Warning>

**Bonnes pratiques :**
- ‚úÖ `anon key` : Safe pour frontend (prot√©g√© par RLS)
- ‚ùå `service_role key` : Backend seulement, jamais expos√©
- üîÑ R√©g√©n√©rez les cl√©s si compromises

---

### RLS Testing

Testez toujours avec un utilisateur non-authentifi√© :

```typescript
// Cr√©er un client non-auth
const publicClient = createClient(supabaseUrl, anonKey);

// Tester lecture (devrait fonctionner)
const { data: tools } = await publicClient.from('tools').select('*');
console.log(tools); // ‚úÖ Liste des outils

// Tester √©criture (devrait √©chouer)
const { error } = await publicClient
  .from('tools')
  .insert({ name: 'Hack' });
console.log(error); // ‚ùå "new row violates row-level security policy"
```

---

### SQL Injection Protection

Supabase prot√®ge automatiquement contre SQL injection via :
- Prepared statements
- Parameterized queries
- RLS enforcement

**√âvitez quand m√™me :**
```typescript
// ‚ùå Mauvais : concat√©nation de strings
const { data } = await supabase
  .rpc('unsafe_query', { 
    query: `SELECT * FROM tools WHERE name = '${userInput}'` 
  });

// ‚úÖ Bon : utiliser les m√©thodes Supabase
const { data } = await supabase
  .from('tools')
  .select('*')
  .eq('name', userInput);
```

---

## Troubleshooting

### Erreur : "relation does not exist"

**Cause :** Table non cr√©√©e ou migration √©chou√©e

**Solution :**
1. V√©rifiez dans **Table Editor** que la table existe
2. R√©ex√©cutez la migration dans SQL Editor
3. V√©rifiez les logs de migration

---

### Erreur : "new row violates row-level security policy"

**Cause :** RLS bloque l'op√©ration

**Solution :**
1. V√©rifiez que vous √™tes authentifi√©
2. V√©rifiez les policies de la table
3. Testez avec `service_role key` pour bypasser RLS (debug uniquement)

---

### Slow queries

**Analyse :**
```sql
-- Queries lentes
SELECT * FROM pg_stat_statements 
ORDER BY total_exec_time DESC 
LIMIT 10;
```

**Solutions :**
- Ajoutez des indexes
- Optimisez les queries
- Utilisez le cache
- Passez au plan Pro (plus de CPU)

---

## Checklist production

Avant de lancer en production :

- [ ] Toutes les migrations ex√©cut√©es
- [ ] 13 tables cr√©√©es
- [ ] RLS activ√© sur toutes les tables
- [ ] Policies test√©es
- [ ] 2 buckets Storage cr√©√©s
- [ ] User admin cr√©√© et test√©
- [ ] Backups automatiques activ√©s
- [ ] Monitoring configur√©
- [ ] Variables env dans Netlify
- [ ] Test complet de l'app

---

## Ressources

<CardGroup cols={2}>
  <Card title="Supabase Docs" icon="book" href="https://supabase.com/docs">
    Documentation officielle
  </Card>
  
  <Card title="Database Schema" icon="database" href="/database/schema">
    Structure des tables
  </Card>
  
  <Card title="RLS Guide" icon="shield" href="/database/rls">
    Row Level Security
  </Card>
  
  <Card title="Netlify Setup" icon="globe" href="/deployment/netlify">
    Configuration Netlify
  </Card>
</CardGroup>